doctype html
html(lang="en")
    head
        title Report #{period.start} to #{period.end}
        link(href="style.css", rel="stylesheet")
        script(src="https://cdn.jsdelivr.net/npm/chart.js")
        script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js")
    body
        div
            h2 Merged events for period #{period.start} to #{period.end}
            div(class='container-sm text-left')
                h3 Aggregated Statistics
                div.row
                    div(class='col-lg-10 text-secondary')
                        div.row
                            div(class='col-sm-12 mb-3 mb-sm-0')
                                div(class='card mb-3')
                                    div(class='card-body text-center')
                                        h5.card-title #{stats.average.months} months, #{stats.average.days} days, #{stats.average.hours} hours, #{stats.average.minutes} minutes, #{stats.average.seconds} seconds
                                        p.card-text
                                            em Average time to merge
                        div.row
                            div(class='col-sm-3 mb-3 mb-sm-0')
                                div(class='card mb-3')
                                    div(class='card-body text-center')
                                        h5(class='card-title text-merged') #{stats.total.merged}
                                        p.card-text
                                         em # Merged
                            div(class='col-sm-3 mb-3 mb-sm-0')
                                div(class='card mb-3')
                                    div(class='card-body text-center')
                                        h5(class='card-title text-opened') #{stats.total.opened}
                                        p.card-text
                                            em # Opened
                            div(class='col-sm-3 mb-3 mb-sm-0')
                                div(class='card mb-3')
                                    div(class='card-body text-center')
                                        h5(class='card-title text-closed') #{stats.total.closed}
                                        p.card-text
                                            em # Closed
                            div(class='col-sm-3 mb-3 mb-sm-0')
                                div(class='card mb-3')
                                    div(class='card-body text-center')
                                        h5(class='card-title text-total') #{stats.total.all}
                                        p.card-text
                                            em # Overall
                    div.col-lg-2
                        div.row
                            div
                                canvas#aggregated-statistics
            div.container-sm
                div(class="accordion")
                    div(class="accordion-item")
                        h2(class="accordion-header")
                            button(class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#months" aria-expanded="true" aria-controls="months")
                                p Months
                        div(id='months' class="accordion-collapse collapse show")
                            div(class="accordion-body")
                                canvas#merged-events
                    div(class="accordion-item")
                        h2(class="accordion-header")
                            button(class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#weeks" aria-expanded="true" aria-controls="weeks")
                                p Weeks
                        div(id='weeks' class="accordion-collapse collapse")
                            div(class="accordion-body")
                                canvas#merged-events-weeks


        script(type='text/javascript').

            function initializeDataSet(data) {
                return [{
                    label: '# of Merge Requests merged',
                    data: data,
                    borderWidth: 3,
                    borderJoinStyle: "round",
                    tension: 0.2
                }];
            }
            const mergeRequestChartType = 'line'


            const monthsMergeRequestContext = document.getElementById('merged-events');
            const monthsMergeRequestChartDatasets = initializeDataSet([#{stats.mr.months.data}]);
            const monthsMergeRequestChartLabels = !{stringify(stats.mr.months.labels)}

            const weeksMergeRequestContext = document.getElementById('merged-events-weeks');
            const weeksMergeRequestChartDatasets = initializeDataSet([#{stats.mr.weeks.data}]);
            const weeksMergeRequestChartLabels = !{stringify(stats.mr.weeks.labels)}

            const aggregatedMergeRequestContext = document.getElementById("aggregated-statistics")
            const aggregatedMergeRequestChartType = 'doughnut'
            const aggregatedMergeRequestChartLabels = ['Merged', 'Opened', 'Closed', 'All']
            const aggregatedMergeRequestChartDatasets =    [{
                label: 'Aggregated merge requests',
                data: [
                    #{stats.total.merged},
                    #{stats.total.opened},
                    #{stats.total.closed},
                    #{stats.total.all}
                ],
                hoverOffset: 4
            }]

            function renderChart(context, type, labels, datasets) {
                new Chart(context, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: datasets,
                    },
                    options: {}
                });
            }

            renderChart(monthsMergeRequestContext, mergeRequestChartType, monthsMergeRequestChartLabels, monthsMergeRequestChartDatasets);
            renderChart(weeksMergeRequestContext, mergeRequestChartType, weeksMergeRequestChartLabels, weeksMergeRequestChartDatasets);
            renderChart(aggregatedMergeRequestContext, aggregatedMergeRequestChartType, aggregatedMergeRequestChartLabels, aggregatedMergeRequestChartDatasets);
